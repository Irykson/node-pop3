{"version":3,"file":"Connection.js","names":["value","then","direct","Promise","resolve","Pop3Connection","host","port","tls","timeout","tlsOptions","servername","_socket","_stream","_command","Readable","read","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","socket","Socket","setKeepAlive","reject","setTimeout","Error","eventName","listeners","length","end","options","Object","assign","_tls","connect","on","_pushStream","command","firstLineEndIndex","indexOf","CRLF_BUFFER","infoBuffer","split","commandName","stream","MULTI_LINE_COMMAND_NAME","includes","_updateStream","bodyBuffer","toString","once","args","join","rejectFn","info","removeListener","write","CRLF","EventEmitter"],"sources":["../src/Connection.mjs"],"sourcesContent":["import { Socket } from 'net';\nimport _tls from 'tls';\nimport { EventEmitter } from 'events';\nimport { Readable } from 'stream';\n\nimport {\n  CRLF,\n  CRLF_BUFFER,\n  TERMINATOR_BUFFER,\n  TERMINATOR_BUFFER_ARRAY,\n  MULTI_LINE_COMMAND_NAME\n} from './constant.mjs';\n\nclass Pop3Connection extends EventEmitter {\n  constructor({\n    host,\n    port,\n    tls,\n    timeout,\n    tlsOptions,\n    servername\n  }) {\n    super();\n    this.host = host;\n    this.port = port || (tls ? 995 : 110);\n    this.tls = tls;\n    this.timeout = timeout;\n    this._socket = null;\n    this._stream = null;\n    this._command;\n    this.tlsOptions = tlsOptions || {};\n    this.servername = servername || host;\n  }\n\n  _updateStream() {\n    this._stream = new Readable({\n      read: () => {},\n    });\n    return this._stream;\n  }\n\n  _pushStream(buffer) {\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\n      return this._endStream();\n    }\n    const endBuffer = buffer.slice(-5);\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\n      this._stream.push(buffer.slice(0, -5));\n      return this._endStream();\n    }\n    this._stream.push(buffer);\n  }\n\n  _endStream(err) {\n    if (this._stream) {\n      this._stream.push(null);\n    }\n    this._stream = null;\n    this.emit('end', err);\n  }\n\n  connect() {\n    const { host, port, tlsOptions, servername } = this;\n    const socket = new Socket();\n    socket.setKeepAlive(true);\n    return new Promise((resolve, reject) => {\n      if (typeof this.timeout !== 'undefined') {\n        socket.setTimeout(this.timeout, () => {\n          const err = new Error('timeout');\n          err.eventName = 'timeout';\n          reject(err);\n          if (this.listeners('end').length) {\n            this.emit('end', err);\n          }\n          if (this.listeners('error').length) {\n            this.emit('error', err);\n          }\n          this._socket.end();\n          this._socket = null;\n        });\n      }\n      if (this.tls) {\n        const options = Object.assign({ host, port, socket, servername }, tlsOptions);\n        this._socket = _tls.connect(options);\n      } else {\n        this._socket = socket;\n      }\n\n      this._socket.on('data', (buffer) => {\n        if (this._stream) {\n          return this._pushStream(buffer);\n        }\n        if (buffer[0] === 45) { // '-'\n          const err = new Error(buffer.slice(5, -2));\n          err.eventName = 'error';\n          err.command = this._command;\n          return this.emit('error', err);\n        }\n        if (buffer[0] === 43) { // '+'\n          const firstLineEndIndex = buffer.indexOf(CRLF_BUFFER);\n          const infoBuffer = buffer.slice(4, firstLineEndIndex);\n          const [commandName] = (this._command || '').split(' ');\n          let stream = null;\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName)) {\n            this._updateStream();\n            stream = this._stream;\n            const bodyBuffer = buffer.slice(firstLineEndIndex + 2);\n            if (bodyBuffer[0]) {\n              this._pushStream(bodyBuffer);\n            }\n          }\n          this.emit('response', infoBuffer.toString(), stream);\n          resolve();\n          return;\n        }\n        const err = new Error('Unexpected response');\n        err.eventName = 'bad-server-response';\n        reject(err);\n      });\n      this._socket.on('error', (err) => {\n        err.eventName = 'error';\n        if (this._stream) {\n          this.emit('error', err);\n          return;\n        }\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('close', () => {\n        const err = new Error('close');\n        err.eventName = 'close';\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('end', () => {\n        const err = new Error('end');\n        err.eventName = 'end';\n        reject(err);\n        this._socket = null;\n      });\n      socket.connect({\n        host,\n        port,\n      });\n    });\n  }\n\n  async command(...args) {\n    this._command = args.join(' ');\n    if (!this._socket) {\n      throw new Error('no-socket');\n    }\n    await new Promise((resolve, reject) => {\n      if (!this._stream) {\n        return resolve();\n      }\n      this.once('error', (err) => {\n        return reject(err);\n      });\n      this.once('end', (err) => {\n        return err ? reject(err) : resolve();\n      });\n    });\n    return new Promise((resolve, reject) => {\n      const rejectFn = (err) => reject(err);\n      this.once('error', rejectFn);\n      this.once('response', (info, stream) => {\n        this.removeListener('error', rejectFn);\n        resolve([info, stream]);\n      });\n      if (!this._socket) {\n        reject(new Error('no-socket'));\n      }\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\n    });\n  }\n}\n\nexport default Pop3Connection;\n"],"mappings":"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"}