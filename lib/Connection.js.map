{"version":3,"sources":["../src/Connection.js"],"names":["Pop3Connection","host","port","tls","timeout","_socket","_stream","_command","Readable","read","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","socket","Socket","setKeepAlive","Promise","resolve","reject","setTimeout","Error","eventName","listeners","length","end","_tls","connect","on","_pushStream","command","firstLineEndIndex","indexOf","CRLF_BUFFER","infoBuffer","split","commandName","stream","MULTI_LINE_COMMAND_NAME","includes","_updateStream","bodyBuffer","toString","once","args","join","rejectFn","info","removeListener","write","CRLF","EventEmitter"],"mappings":"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","sourcesContent":["import { Socket } from 'net';\nimport _tls from 'tls';\nimport { EventEmitter } from 'events';\nimport { Readable } from 'stream';\n\nimport {\n  CRLF,\n  CRLF_BUFFER,\n  TERMINATOR_BUFFER,\n  TERMINATOR_BUFFER_ARRAY,\n  MULTI_LINE_COMMAND_NAME\n} from './constant';\n\nclass Pop3Connection extends EventEmitter {\n  constructor({\n    host,\n    port,\n    tls,\n    timeout,\n  }) {\n    super();\n    this.host = host;\n    this.port = port || (tls ? 995 : 110);\n    this.tls = tls;\n    this.timeout = timeout;\n    this._socket = null;\n    this._stream = null;\n    this._command;\n  }\n\n  _updateStream() {\n    this._stream = new Readable({\n      read: () => {},\n    });\n    return this._stream;\n  }\n\n  _pushStream(buffer) {\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\n      return this._endStream();\n    }\n    const endBuffer = buffer.slice(-5);\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\n      this._stream.push(buffer.slice(0, -5));\n      return this._endStream();\n    }\n    this._stream.push(buffer);\n  }\n\n  _endStream(err) {\n    this._stream.push(null);\n    this._stream = null;\n    this.emit('end', err);\n  }\n\n  connect() {\n    const { host, port } = this;\n    const socket = new Socket();\n    socket.setKeepAlive(true);\n    return new Promise((resolve, reject) => {\n      if (typeof this.timeout !== 'undefined') {\n        socket.setTimeout(this.timeout, () => {\n          const err = new Error('timeout');\n          err.eventName = 'timeout';\n          reject(err);\n          if (this.listeners('end').length) {\n            this.emit('end', err);\n          }\n          if (this.listeners('error').length) {\n            this.emit('error', err);\n          }\n          this._socket.end();\n          this._socket = null;\n        });\n      }\n      if (this.tls) {\n        this._socket = _tls.connect({\n          host,\n          port,\n          socket,\n        });\n      } else {\n        this._socket = socket;\n      }\n\n      this._socket.on('data', (buffer) => {\n        if (this._stream) {\n          return this._pushStream(buffer);\n        }\n        if (buffer[0] === 45) {// '-'\n          const err = new Error(buffer.slice(5, -2));\n          err.eventName = 'error';\n          err.command = this._command;\n          return this.emit('error', err);\n        }\n        if (buffer[0] === 43) {// '+'\n          const firstLineEndIndex = buffer.indexOf(CRLF_BUFFER);\n          const infoBuffer = buffer.slice(4, firstLineEndIndex);\n          const [commandName] = (this._command || '').split(' ');\n          let stream = null;\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName)) {\n            this._updateStream();\n            stream = this._stream;\n            const bodyBuffer = buffer.slice(firstLineEndIndex + 2);\n            if (bodyBuffer[0]) {\n              this._pushStream(bodyBuffer);\n            }\n          }\n          this.emit('response', infoBuffer.toString(), stream);\n        }\n        resolve();\n      });\n      this._socket.on('error', (err) => {\n        err.eventName = 'error';\n        if (this._stream) {\n          return this.emit('error', err);\n        }\n        reject(err);\n      });\n      this._socket.once('close', () => {\n        const err = new Error('close');\n        err.eventName = 'close';\n        reject(err);\n        this._socket = null;\n      });\n      this._socket.once('end', () => {\n        const err = new Error('end');\n        err.eventName = 'end';\n        reject(err);\n        this._socket = null;\n      });\n      socket.connect({\n        host,\n        port,\n      });\n    });\n  }\n\n  async command(...args) {\n    this._command = args.join(' ');\n    await new Promise((resolve, reject) => {\n      if (!this._stream) {\n        return resolve();\n      }\n      this.once('end', (err) => {\n        return err ? reject(err) : resolve();\n      });\n    });\n    return new Promise((resolve, reject) => {\n      const rejectFn = (err) => reject(err);\n      this.once('error', rejectFn);\n      this.once('response', (info, stream) => {\n        this.removeListener('error', rejectFn);\n        resolve([info, stream]);\n      });\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\n    });\n  }\n}\n\nexport default Pop3Connection;\n"],"file":"Connection.js"}