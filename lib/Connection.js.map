{"version":3,"sources":["../src/Connection.mjs"],"names":["value","then","direct","Promise","resolve","Pop3Connection","host","port","tls","timeout","tlsOptions","_socket","_stream","_command","Readable","read","buffer","TERMINATOR_BUFFER_ARRAY","some","_buffer","equals","_endStream","endBuffer","slice","TERMINATOR_BUFFER","push","err","emit","socket","Socket","setKeepAlive","reject","setTimeout","Error","eventName","listeners","length","end","options","Object","assign","_tls","connect","on","_pushStream","command","firstLineEndIndex","indexOf","CRLF_BUFFER","infoBuffer","split","commandName","stream","MULTI_LINE_COMMAND_NAME","includes","_updateStream","bodyBuffer","toString","once","args","join","rejectFn","info","removeListener","write","CRLF","EventEmitter"],"mappings":"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","sourcesContent":["import { Socket } from 'net';\r\nimport _tls from 'tls';\r\nimport { EventEmitter } from 'events';\r\nimport { Readable } from 'stream';\r\n\r\nimport {\r\n  CRLF,\r\n  CRLF_BUFFER,\r\n  TERMINATOR_BUFFER,\r\n  TERMINATOR_BUFFER_ARRAY,\r\n  MULTI_LINE_COMMAND_NAME\r\n} from './constant.mjs';\r\n\r\nclass Pop3Connection extends EventEmitter {\r\n  constructor({\r\n    host,\r\n    port,\r\n    tls,\r\n    timeout,\r\n    tlsOptions,\r\n  }) {\r\n    super();\r\n    this.host = host;\r\n    this.port = port || (tls ? 995 : 110);\r\n    this.tls = tls;\r\n    this.timeout = timeout;\r\n    this._socket = null;\r\n    this._stream = null;\r\n    this._command;\r\n    this.tlsOptions = tlsOptions || {};\r\n  }\r\n\r\n  _updateStream() {\r\n    this._stream = new Readable({\r\n      read: () => {},\r\n    });\r\n    return this._stream;\r\n  }\r\n\r\n  _pushStream(buffer) {\r\n    if (TERMINATOR_BUFFER_ARRAY.some((_buffer) => _buffer.equals(buffer))) {\r\n      return this._endStream();\r\n    }\r\n    const endBuffer = buffer.slice(-5);\r\n    if (endBuffer.equals(TERMINATOR_BUFFER)) {\r\n      this._stream.push(buffer.slice(0, -5));\r\n      return this._endStream();\r\n    }\r\n    this._stream.push(buffer);\r\n  }\r\n\r\n  _endStream(err) {\r\n    if (this._stream) {\r\n      this._stream.push(null);\r\n    }\r\n    this._stream = null;\r\n    this.emit('end', err);\r\n  }\r\n\r\n  connect() {\r\n    const { host, port, tlsOptions } = this;\r\n    const socket = new Socket();\r\n    socket.setKeepAlive(true);\r\n    return new Promise((resolve, reject) => {\r\n      if (typeof this.timeout !== 'undefined') {\r\n        socket.setTimeout(this.timeout, () => {\r\n          const err = new Error('timeout');\r\n          err.eventName = 'timeout';\r\n          reject(err);\r\n          if (this.listeners('end').length) {\r\n            this.emit('end', err);\r\n          }\r\n          if (this.listeners('error').length) {\r\n            this.emit('error', err);\r\n          }\r\n          this._socket.end();\r\n          this._socket = null;\r\n        });\r\n      }\r\n      if (this.tls) {\r\n        const options = Object.assign({}, { host, port, socket }, tlsOptions);\r\n        this._socket = _tls.connect(options);\r\n      } else {\r\n        this._socket = socket;\r\n      }\r\n\r\n      this._socket.on('data', (buffer) => {\r\n        if (this._stream) {\r\n          return this._pushStream(buffer);\r\n        }\r\n        if (buffer[0] === 45) { // '-'\r\n          const err = new Error(buffer.slice(5, -2));\r\n          err.eventName = 'error';\r\n          err.command = this._command;\r\n          return this.emit('error', err);\r\n        }\r\n        if (buffer[0] === 43) { // '+'\r\n          const firstLineEndIndex = buffer.indexOf(CRLF_BUFFER);\r\n          const infoBuffer = buffer.slice(4, firstLineEndIndex);\r\n          const [commandName] = (this._command || '').split(' ');\r\n          let stream = null;\r\n          if (MULTI_LINE_COMMAND_NAME.includes(commandName)) {\r\n            this._updateStream();\r\n            stream = this._stream;\r\n            const bodyBuffer = buffer.slice(firstLineEndIndex + 2);\r\n            if (bodyBuffer[0]) {\r\n              this._pushStream(bodyBuffer);\r\n            }\r\n          }\r\n          this.emit('response', infoBuffer.toString(), stream);\r\n          resolve();\r\n          return;\r\n        }\r\n        const err = new Error('Unexpected response');\r\n        err.eventName = 'bad-server-response';\r\n        reject(err);\r\n      });\r\n      this._socket.on('error', (err) => {\r\n        err.eventName = 'error';\r\n        if (this._stream) {\r\n          this.emit('error', err);\r\n          return;\r\n        }\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      this._socket.once('close', () => {\r\n        const err = new Error('close');\r\n        err.eventName = 'close';\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      this._socket.once('end', () => {\r\n        const err = new Error('end');\r\n        err.eventName = 'end';\r\n        reject(err);\r\n        this._socket = null;\r\n      });\r\n      socket.connect({\r\n        host,\r\n        port,\r\n      });\r\n    });\r\n  }\r\n\r\n  async command(...args) {\r\n    this._command = args.join(' ');\r\n    if (!this._socket) {\r\n      throw new Error('no-socket');\r\n    }\r\n    await new Promise((resolve, reject) => {\r\n      if (!this._stream) {\r\n        return resolve();\r\n      }\r\n      this.once('error', (err) => {\r\n        return reject(err);\r\n      });\r\n      this.once('end', (err) => {\r\n        return err ? reject(err) : resolve();\r\n      });\r\n    });\r\n    return new Promise((resolve, reject) => {\r\n      const rejectFn = (err) => reject(err);\r\n      this.once('error', rejectFn);\r\n      this.once('response', (info, stream) => {\r\n        this.removeListener('error', rejectFn);\r\n        resolve([info, stream]);\r\n      });\r\n      if (!this._socket) {\r\n        reject(new Error('no-socket'));\r\n      }\r\n      this._socket.write(`${this._command}${CRLF}`, 'utf8');\r\n    });\r\n  }\r\n}\r\n\r\nexport default Pop3Connection;\r\n"],"file":"Connection.js"}